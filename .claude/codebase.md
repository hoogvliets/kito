# kito - Claude Code Reference Document

*Last updated: 2025-12-18*

## Project Overview

**kito** is a self-hosted personal newsfeed aggregator and customizable dashboard. It combines RSS feed reading with a widget-based home screen, all running client-side with dynamic feed fetching and widget management.

**Key Concepts**:
- **Zero-infrastructure**: Runs entirely on GitHub Pages, no backend server required
- **User-configurable**: Create up to 10 custom feed pages, each aggregating multiple RSS feeds
- **Client-side RSS parsing**: Fetches and parses RSS/Atom feeds directly in the browser
- **Smart caching**: 30-minute feed cache to reduce API calls and improve performance

## Architecture & Tech Stack

- **Frontend**: Vanilla JavaScript (ES6+), HTML5, CSS3
- **Styling**: Custom CSS with CSS variables for theming
- **Storage**: Browser LocalStorage (with TTL-based caching)
- **RSS Parsing**: Custom RSS/Atom parser (`js/rss-parser.js`)
- **YAML Parsing**: js-yaml library (CDN) + custom parser
- **Data Source**: Dynamic RSS feeds + Static JSON files (GitHub Actions)
- **Weather API**: Open-Meteo (free, no API key)
- **Favicon Service**: Google Favicon API
- **Deployment**: GitHub Pages
- **Automation**: GitHub Actions (scheduled cron jobs)

## File Structure

```
/
├── index.html           # Main HTML file with templates (~557 lines)
├── css/
│   └── styles.css       # All styling including themes
├── js/
│   ├── app.js          # Main application logic (~2506 lines)
│   └── rss-parser.js   # RSS feed parsing utilities
├── data/               # JSON feed data (generated by Actions)
│   ├── feed.json       # Tech feed
│   ├── news.json       # News feed
│   ├── ball.json       # Sports feed
│   ├── sidebar.json    # Hacker News sidebar
│   ├── ticker.json     # Additional feed data
│   ├── linkedin.json   # LinkedIn feed
│   └── raw_linkedin.json
├── scripts/            # Python data processing scripts
├── config/             # Feed configuration files (YAML)
│   └── feed-pages.yaml # Dynamic feed page configuration
└── .github/workflows/  # GitHub Actions for automation
```

## Core Application State

The entire app state lives in a single `state` object (js/app.js:3-32):

```javascript
const state = {
    feedPages: [],         // Array of {id, name, order, feedSources, data}
    sidebar: [],           // Hacker News sidebar items
    widgets: [],           // User's widgets (bookmarks, notes, etc.)

    // Computed property - returns current view's feed data
    get activeFeed() {
        const page = this.feedPages.find(p => p.id === this.currentView);
        return page ? page.data : [];
    },

    filteredFeed: [],      // After applying filters
    page: 1,               // Infinite scroll pagination
    itemsPerPage: 10,
    loading: false,
    hasMore: true,
    filters: {
        source: 'all',
        favoritesOnly: false
    },
    userSettings: {
        read: [],          // Article IDs marked as read
        favorites: [],     // Article IDs favorited
        hidden: [],        // Article IDs hidden
        theme: 'light',    // 'light' or 'dark'
    },
    currentView: 'home',   // 'home' | 'config' | {dynamic-feed-page-id}
    currentWidgetId: null, // For modal context
    draggedWidget: null    // For drag-and-drop
};
```

**Key Architectural Change**: The app now uses a **dynamic feed page system** instead of hardcoded feed arrays (tech, news, ball). Feed pages are user-configurable and stored in `state.feedPages` with this structure:

```javascript
{
    id: "unique-page-id",      // Used as view identifier
    name: "Page Name",         // Display name (user-editable)
    order: 0,                  // Sort order for navigation
    feedSources: [             // Array of RSS feed URLs
        "https://example.com/feed.xml",
        // ... more feeds
    ],
    data: []                   // Fetched and merged feed items
}
```

## View System

The app uses a **hybrid static/dynamic view system**:

### Static Views
1. **Home** (`view-home`) - Widget dashboard
2. **Config** (`view-config`) - Configuration and feed management

### Dynamic Feed Page Views
Feed page views are created at runtime based on `state.feedPages`. Each feed page gets:
- View container: `<div id="view-{pageId}" class="view-section">`
- Feed container: `<section id="{pageId}-feed-container">`
- Sidebar container: `<aside id="{pageId}-sidebar-container">`

**Creation**: `createFeedView(pageId)` (js/app.js:234)
**Navigation**:
- `switchView(viewName)` (js/app.js:271+)
- `renderNavigation()` (js/app.js:196) - Dynamically generates nav buttons

**Maximum**: Up to 10 feed pages can be created (enforced in `addFeedPage()`)

## Widget System

### Widget Types

All widgets stored in `state.widgets` array and persisted to `localStorage['widgets-data']`.

**5 Widget Types:**
1. **Bookmarks** - List of titled links
2. **Launchpad** - Visual grid of site favicons (3x3)
3. **Notes** - Simple textarea for notes
4. **Weather** - Current weather + 4-hour forecast
5. **Todo** - Task list with checkboxes

### Widget Schema

```javascript
{
    id: "timestamp",
    type: "bookmarks|launchpad|notes|weather|todo",
    title: "Widget Title",

    // Type-specific fields:
    links: [...],      // bookmarks only
    sites: [...],      // launchpad only
    notes: "...",      // notes only
    location: "...",   // weather only
    weather: {...},    // weather only (not exported)
    todos: [...]       // todo only
}
```

### Widget Operations

- **Create**: `saveWidget()` (js/app.js:624)
- **Delete**: `deleteWidget(widgetId)` (js/app.js:662)
- **Render**: `renderWidgets()` (js/app.js:795)
- **Drag & Drop**: `handleDragStart/End/Over/Drop()` (js/app.js:1189-1221)

### Weather Widget

Uses **Open-Meteo API** (free, no key required):
1. Geocode location: `https://geocoding-api.open-meteo.com/v1/search`
2. Fetch weather: `https://api.open-meteo.com/v1/forecast`

Function: `fetchWeather(widgetId, location)` (js/app.js:1224-1303)

Weather data is NOT exported in config (too volatile). Only location is saved.

## Feed System

### Dynamic Feed Page Architecture

The feed system is now **fully user-configurable**. Users can create, edit, and delete feed pages, each with multiple RSS feed sources.

### Feed Page Management

**Configuration Loading**: (js/app.js:544-609)
1. `loadFeedPageConfig()` - Loads from localStorage or YAML
2. `initializeFeedPages()` - Initializes with automatic migration from legacy format
3. Supports both:
   - **New format**: `config/feed-pages.yaml` (using js-yaml library)
   - **Legacy format**: Migrates from `tech-feed.yaml`, `news-feed.yaml`, `ball-feed.yaml`

**CRUD Operations**:
- `addFeedPage(name)` (js/app.js:1980) - Create new feed page (max 10)
- `deleteFeedPage(pageId)` (js/app.js:2001) - Remove feed page
- `renameFeedPage(pageId, newName)` (js/app.js:2031) - Edit page name
- `moveFeedPage(pageId, direction)` (js/app.js:2053) - Reorder pages
- `addFeedSource(pageId, url)` (js/app.js:2074) - Add RSS feed URL to page
- `removeFeedSource(pageId, url)` (js/app.js:2103) - Remove RSS feed from page

**UI Management**:
- `renderFeedsManager()` (js/app.js:1766) - Renders feed management UI in config view
- `attachFeedsManagerListeners()` (js/app.js:1868) - Wires up event handlers

### RSS Feed Fetching

**Client-Side Parsing**: Uses `js/rss-parser.js` to parse RSS/Atom feeds directly in the browser.

**Fetch Functions**:
- `fetchSingleFeed(feedUrl, cacheTTL)` (js/app.js:411) - Fetches and parses one RSS feed
- `fetchAllFeeds(feedUrls, category)` (js/app.js:472) - Batch fetches multiple feeds in parallel
- `fetchFeedPage(page)` (js/app.js:638) - Fetches all feeds for a feed page
- `deduplicatePosts(posts)` (js/app.js:460) - Removes duplicate articles by ID

**Caching System** (30-minute TTL):
- `getCachedFeed(cacheKey, ttl)` (js/app.js:348) - Retrieves cached feed data
- `cacheFeed(cacheKey, data)` (js/app.js:373) - Stores feed in localStorage
- `clearFeedCache()` (js/app.js:398) - Clears all cached feeds
- Cache keys: `feed-cache-{base64(url)}`

### Feed Item Schema

```javascript
{
    id: "unique-id",
    title: "Article Title",
    link: "https://...",
    summary: "Description...",
    author: "Author Name",
    source: "Source Name",
    published: "ISO-8601 date",
    image: "https://..." // optional
}
```

### Feed Features

- **Filtering**: By source, favorites only
- **Actions**: Read, favorite, hide
- **Infinite Scroll**: Intersection Observer
- **Dual Columns**: Main feed + Hacker News sidebar
- **Target="_blank"**: All feed links open in new tabs

## Configuration Import/Export

**Format**: YAML (custom parser/stringifier)

**Functions**:
- Export: `exportConfig()` (js/app.js:2277) → Downloads `.yaml` file
- Import: `importConfig(yamlText)` (js/app.js:2315) → Restores from YAML
- Copy to Clipboard: `copyConfigToClipboard()` (js/app.js:2402)
- Paste from Clipboard: `pasteConfigFromClipboard()` (js/app.js:2437)

**YAML Utilities**:
- `objectToYaml()` (js/app.js:2138) - Custom YAML stringifier
- `yamlToObject()` (js/app.js:2185) - Custom YAML parser

**What's Exported**:
- **Feed pages** (structure only, not data):
  - `id`, `name`, `order`, `feedSources` array
- **Widgets** (except weather data):
  - All widget types with their full configuration
- **User settings**:
  - `theme`, `read`, `favorites`, `hidden` arrays
- **Metadata**:
  - Version, export timestamp

**Example Export Structure**:
```yaml
feedPages:
  - id: tech
    name: Tech News
    order: 0
    feedSources:
      - https://example.com/feed.xml
widgets:
  - id: "123456"
    type: bookmarks
    title: My Links
    links: [...]
userSettings:
  theme: dark
  read: [...]
  favorites: [...]
  hidden: [...]
```

## Local Storage

**Keys Used**:
1. `feed-pages-config` - Feed page configuration (structure only, not data)
2. `widgets-data` - JSON array of widget objects
3. `newsfeed-settings` - User settings object
4. `feed-cache-{hash}` - Cached RSS feed data (30-minute TTL)

**Schema**:
```javascript
// feed-pages-config
{
  feedPages: [
    {
      id: "page-id",
      name: "Page Name",
      order: 0,
      feedSources: ["url1", "url2"]
    }
  ]
}

// widgets-data
[
  { id, type, title, ... },
  ...
]

// newsfeed-settings
{
  read: ["id1", "id2"],
  favorites: ["id1"],
  hidden: ["id3"],
  theme: "light|dark"
}

// feed-cache-{base64(url)} (with timestamp)
{
  timestamp: 1234567890,
  data: [...]  // Array of feed items
}
```

## Theming

**Implementation**: CSS custom properties + `data-theme` attribute

Toggle: `toggleTheme()` (js/app.js:1322-1326)

Themes defined in `css/styles.css` using `:root[data-theme="dark"]` selectors.

## Templates

HTML templates defined in `<template>` tags (index.html:302-591):
- `feed-item-template` - Feed article cards
- `sidebar-item-template` - Sidebar items
- `widget-*-template` - Each widget type
- `bookmark-link-template` - Bookmark items
- `launchpad-item-template` - Launchpad sites
- `todo-item-template` - Todo tasks
- `weather-hourly-item-template` - Weather hourly forecasts

Cloned and populated via `document.importNode()` / `.cloneNode(true)`

## Key Functions Reference

### Initialization
- `init()` (js/app.js:91) - App entry point
- `setupEventListeners()` - Wire up UI events
- `setupWidgetListeners()` - Widget-specific events
- `initializeFeedPages()` (js/app.js:571) - Initialize feed pages with migration

### View Management
- `switchView(viewName)` (js/app.js:271+) - Switch between views
- `createFeedView(pageId)` (js/app.js:234) - Dynamically create feed page view
- `renderNavigation()` (js/app.js:196) - Render navigation buttons

### Feed Page Configuration
- `loadFeedPageConfig()` (js/app.js:544) - Load feed page config
- `saveFeedPageConfig()` (js/app.js:619) - Save feed page config
- `addFeedPage(name)` (js/app.js:1980) - Create new feed page
- `deleteFeedPage(pageId)` (js/app.js:2001) - Delete feed page
- `renameFeedPage(pageId, newName)` (js/app.js:2031) - Rename feed page
- `moveFeedPage(pageId, direction)` (js/app.js:2053) - Reorder feed pages
- `addFeedSource(pageId, url)` (js/app.js:2074) - Add RSS feed to page
- `removeFeedSource(pageId, url)` (js/app.js:2103) - Remove RSS feed from page

### RSS Feed Fetching
- `fetchFeedPage(page)` (js/app.js:638) - Fetch all feeds for a page
- `fetchSingleFeed(feedUrl, cacheTTL)` (js/app.js:411) - Fetch single RSS feed
- `fetchAllFeeds(feedUrls, category)` (js/app.js:472) - Batch fetch multiple feeds
- `getCachedFeed(cacheKey, ttl)` (js/app.js:348) - Get cached feed data
- `cacheFeed(cacheKey, data)` (js/app.js:373) - Cache feed data
- `clearFeedCache()` (js/app.js:398) - Clear all feed caches
- `deduplicatePosts(posts)` (js/app.js:460) - Remove duplicate articles

### Rendering
- `renderFeed(append)` (js/app.js:730) - Render article feed
- `renderSidebar()` (js/app.js:820) - Render HN sidebar
- `renderWidgets()` (js/app.js:1250) - Render widget grid
- `renderFeedsManager()` (js/app.js:1766) - Render feed management UI
- `attachFeedsManagerListeners()` (js/app.js:1868) - Attach feed manager event handlers

### Data & Filtering
- `applyFilters()` - Filter feed by criteria
- `populateSourceFilter()` - Update source dropdown

### User Actions
- `toggleFavorite(id, btn)` (js/app.js:1004) - Toggle favorite status
- `hidePost(id, card)` (js/app.js:1020) - Hide article
- `toggleRead(id, card)` (js/app.js:1034) - Toggle read status
- `handleLinkClick(e, id, card)` - Auto-mark as read

### Widget Management
- `loadWidgets()` - Load widgets from localStorage
- `saveWidgets()` - Save widgets to localStorage
- `saveWidget()` - Create/update widget
- `deleteWidget(widgetId)` - Delete widget
- `fetchWeather(widgetId, location)` - Fetch weather data

### Configuration Import/Export
- `exportConfig()` (js/app.js:2277) - Export config to YAML
- `importConfig(yamlText)` (js/app.js:2315) - Import config from YAML
- `copyConfigToClipboard()` (js/app.js:2402) - Copy config to clipboard
- `pasteConfigFromClipboard()` (js/app.js:2437) - Paste config from clipboard
- `objectToYaml()` (js/app.js:2138) - Convert object to YAML
- `yamlToObject()` (js/app.js:2185) - Parse YAML to object

### Persistence
- `loadSettings()` - Load user settings from localStorage
- `saveSettings()` - Save user settings to localStorage

## Development Notes

### Current Branch
- Working on: `feature/links-open-new-tab` (clean working tree)
- Main branch: `main`

### Recent Features

**Links Open in New Tab** (2025-12-18, commit 3017c51):
- All feed article links open with `target="_blank"`
- Bookmark widget links open in new tab
- Launchpad widget sites open in new tab
- Added `rel="noopener noreferrer"` for security

**Dynamic Feed Page System** (latest architecture):
- Users can create up to 10 custom feed pages
- Each page can aggregate multiple RSS feeds
- Full CRUD operations via Config view
- 30-minute feed caching to reduce API calls
- Automatic migration from legacy static feeds

### Common Development Tasks

**Adding a new feed page** (now done via UI):
1. Navigate to Config view
2. Click "Add newsfeed tab"
3. Enter feed name
4. Add RSS feed URLs via the UI

**Adding feeds programmatically**:
1. Edit `config/feed-pages.yaml`
2. Add feed source URLs to existing page's `feedSources` array
3. Reload app to fetch new feeds

**Adding a new widget type:**
1. Add template to `index.html`
2. Add type to widget modal dropdown
3. Update `saveWidget()` schema
4. Add rendering logic in `renderWidgets()`
5. Add any specific handlers (edit, delete, etc.)

**Styling:**
- All styles in `css/styles.css`
- Use CSS variables for theming
- Light/dark themes via `[data-theme]` selector

### Known Patterns

1. **DOM Updates**: Always call `saveWidgets()` or `saveSettings()` after state changes
2. **Re-rendering**: Most functions call `renderWidgets()` or `applyFilters()` after changes
3. **Modals**: Use `.classList.add/remove('hidden')` pattern
4. **IDs**: Use `Date.now().toString()` for new item IDs
5. **Templates**: Clone with `.content.cloneNode(true)`, populate, then append
6. **Computed Properties**: State uses getter methods for derived values (e.g., `activeFeed`)
7. **Dynamic Views**: Views created at runtime with pattern: `view-{pageId}`, `{pageId}-feed-container`
8. **Dataset Attributes**: Heavy use of `data-page-id`, `data-widget-id`, `data-link-id` for element-data association
9. **Feed Caching**: TTL-based caching in localStorage with key pattern `feed-cache-{hash}`
10. **Async Operations**: Feed fetching uses `Promise.allSettled()` for parallel execution
11. **Migration Pattern**: `initializeFeedPages()` handles backward compatibility with legacy config formats

### Potential Improvements

- [ ] Add widget categories/folders
- [ ] RSS feed widget (display any RSS feed in a widget)
- [ ] Search functionality across feeds
- [ ] Keyboard shortcuts
- [ ] Export/import favorites separately
- [ ] Calendar widget
- [ ] Custom CSS per widget
- [ ] Widget resize/custom grid layout
- [ ] PWA/offline support
- [ ] Feed update notifications
- [ ] Custom feed refresh intervals per page
- [ ] Import/export individual feed pages

## Important Constraints

1. **Minimal dependencies** - Pure vanilla JS + js-yaml (CDN)
2. **No build process** - Everything runs in browser
3. **Static files only** - No server-side processing (RSS feeds fetched client-side)
4. **LocalStorage limits** - ~5-10MB total (including feed cache)
5. **CORS** - RSS feeds, Weather API, and Favicons must support CORS
6. **GitHub Pages** - Static hosting only
7. **Feed page limit** - Maximum 10 feed pages (enforced in UI)
8. **Cache TTL** - Feed cache expires after 30 minutes

## Debugging Tips

1. **Check console logs** - Heavy use of `console.log()` throughout
2. **LocalStorage inspector** - View `widgets-data`, `newsfeed-settings`, `feed-pages-config`, and feed caches
3. **Network tab** - Check RSS feed fetches, weather API calls, and caching behavior
4. **Test import/export** - Good way to inspect full app configuration
5. **Breakpoints**:
   - `renderWidgets()` (js/app.js:1250) - Widget rendering logic
   - `fetchFeedPage()` (js/app.js:638) - Feed fetching and caching
   - `initializeFeedPages()` (js/app.js:571) - Feed page initialization and migration
6. **Clear feed cache** - Use browser console: `localStorage` keys starting with `feed-cache-`
7. **Feed page config** - Inspect `localStorage.getItem('feed-pages-config')` to see current setup
8. **CORS issues** - RSS feeds must support CORS; check Network tab for failed requests

## Server Setup

**Local Development:**
```bash
# Port 5500 (as currently running)
python3 -m http.server 5500
```

Then visit: http://localhost:5500

**Data Processing** (requires Python):
```bash
python3 scripts/process_data.py
```

## Git Workflow

Standard workflow:
1. Make changes
2. Test locally
3. Commit to feature branch
4. Merge to `main`
5. GitHub Actions auto-deploys to Pages

---

*This document is for Claude Code's reference to understand the project architecture and make informed development decisions.*
